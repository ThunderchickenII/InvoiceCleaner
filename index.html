<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice Markup Tool</title>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 20px; background: #f9f9fb; }
    .container { max-width: 1400px; margin: auto; }
    .controls { margin: 20px 0; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #btnImport { background: #27ae60; color: white; }
    #btnImportTax { background: #2980b9; color: white; }
    #btnClear { background: #c0392b; color: white; }
    #btnExportCSV { background: #2980b9; color: white; }
    #btnExportExcel { background: #f39c12; color: white; }
    #btnEditMargins { background: #8e44ad; color: white; }
    #btnPrintPDF { background: #16a085; color: white; }
    input[type="file"], select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    label { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; font-size: 0.9em; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: right; }
    th { background: #34495e; color: white; position: sticky; top: 0; font-size: 0.8em; }
    .service-to { text-align: left !important; font-weight: bold; }
    .subtotal-black td { font-weight: bold; background: #f8f8f8; }
    .subtotal-green td { font-weight: bold; color: #27ae60; background: #e8f5e8; }
    .group-total td { font-weight: bold; background: #fff3cd; }
    .grand-total td { font-weight: bold; font-size: 1.1em; background: #d4edda; color: #155724; }
    .margin-cell { text-align: center; }
    .markup-green { color: #27ae60; font-weight: bold; }
    .markup-black { color: black; font-weight: bold; }
    .tax-total td { background: #e2e3e5; color: #41464b; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .modal label { display: block; margin: 10px 0 5px; font-weight: bold; }
    select, input { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .modal button { margin: 5px; }
    #lstMargins { width: 100%; height: 200px; margin: 10px 0; }
    #status { margin-top: 10px; font-style: italic; color: #555; }

    /* Pie chart container */
    .chart-container {
      margin: 40px auto;
      max-width: 520px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Invoice Markup Tool</h1>
    <div class="controls">
      <input type="file" id="fileInput" accept=".xlsx" />
      <button id="btnImport">Import Invoice</button>
      <input type="file" id="taxInput" accept=".xlsx" />
      <button id="btnImportTax">Import Tax</button>
      <button id="btnClear">Clear Data</button>
      <button id="btnExportCSV">Export CSV</button>
      <button id="btnExportExcel">Export Excel</button>
      <button id="btnEditMargins">Edit Margins</button>
      <button id="btnPrintPDF">Print to PDF</button>
      <label for="filterService">Filter by Service To:</label>
      <select id="filterService"><option value="">Show All</option></select>
    </div>

    <div id="status"></div>
    <h2>Processed Invoice</h2>
    <div id="output"></div>

    <!-- Pie Chart Section - Profit/Margin by Customer -->
    <div class="chart-container">
      <h3 style="text-align: center; margin-bottom: 15px;">Profit / Margin Breakdown by Customer</h3>
      <canvas id="revenuePieChart"></canvas>
    </div>
  </div>

  <div id="marginsModal" class="modal">
    <div class="modal-content">
      <h2>Edit Margin Rules (Enter % to add)</h2>
      <label>Service To:</label>
      <input type="text" id="txtService" placeholder="Type new or existing Service To" list="serviceSuggestions" />
      <datalist id="serviceSuggestions"></datalist>
      <label>SKU:</label>
      <input type="text" id="txtSKU" placeholder="Type new or existing SKU" list="skuSuggestions" />
      <datalist id="skuSuggestions"></datalist>
      <label>Margin % (e.g. 49.1):</label>
      <input type="text" id="txtMargin" placeholder="49.1" />
      <button id="btnAdd">Add / Update</button>
      <button id="btnDelete">Delete Selected</button>
      <button id="btnCloseModal">Close</button>
      <hr style="margin: 15px 0;" />
      <button id="btnExportRules">Export Rules (JSON)</button>
      <input type="file" id="importRulesInput" accept=".json" style="display: block; margin: 10px 0;" />
      <button id="btnImportRules">Import Rules</button>
      <h3>Current Rules</h3>
      <select id="lstMargins" size="10"></select>
    </div>
  </div>

  <script>
    // === MARGIN RULES ===
    let marginRules = [
      ["ECO WINDOW SYSTEMS LLC","A-AUD-OCP1-U",0],
      ["ECO WINDOW SYSTEMS LLC","A-FLEX-NUCL-P",109.65],
      ["GUILD MORTGAGE","A-FLEX-WCC-S-N-O",78.13],
      ["GUILD MORTGAGE","A-FLEX-WCC-P-N-O",78.13],
      ["GUILD MORTGAGE","A-WXCN-PRM-AUTOINT",20],
      ["GUILD MORTGAGE","SVS-CSS-SUPT-SSPT",20],
      ["GUILD MORTGAGE","A-FLEX-EACL",51.92],
      ["GUILD MORTGAGE","A-FLEX-WCC-P-N",49.1],
      ["GUILD MORTGAGE","A-FLEX-WCC-S-N",49.1],
      ["GUILD MORTGAGE","A-AUD-PSTN-IBTF",0],
      ["GUILD MORTGAGE","A-AUD-U-IBTF",0],
      ["GUILD MORTGAGE","A-AUD-OCP1-U",0],
      ["GUILD MORTGAGE","A-AUD-U-TN",0],
      ["GUILD MORTGAGE","A-CHAN-U-V-FRUS-OB",0],
      ["GUILD MORTGAGE","A-CHAN-V-PORTS",0],
      ["GUILD MORTGAGE","A-FLEX-WCE-E",0],
      ["PGT INNOVATIONS","A-FLEX-WCC-S-N-O",171.4],
      ["PGT INNOVATIONS","A-FLEX-WCC-P-N-O",171.4],
      ["PGT INNOVATIONS","SVS-CSS-SUPT-SSPT",120],
      ["PGT INNOVATIONS","A-FLEX-EACL",50.99],
      ["PGT INNOVATIONS","A-FLEX-WCC-P-N",0],
      ["PGT INNOVATIONS","A-FLEX-WCC-S-N",0],
      ["PGT INNOVATIONS","A-AUD-PSTN-IBTF",0],
      ["PGT INNOVATIONS","A-AUD-U-IBTF",0],
      ["PGT INNOVATIONS","A-AUD-OCP1-U",0],
      ["PGT INNOVATIONS","A-AUD-U-TN",0],
      ["PGT INNOVATIONS","A-CHAN-U-V-FRUS-OB",0],
      ["PGT INNOVATIONS","A-CHAN-V-PORTS",0],
      ["PGT INNOVATIONS","A-FLEX-WCE-E",116.22],
      ["LYNN COMMUNITY HEALTH CENTER","A-FLEX-WCC-S-N-O",43.75],
      ["LYNN COMMUNITY HEALTH CENTER","A-FLEX-WCC-P-N-O",43.75],
      ["LYNN COMMUNITY HEALTH CENTER","SVS-CSS-SUPT-SSPT",20],
      ["LYNN COMMUNITY HEALTH CENTER","A-FLEX-EACL",92.31],
      ["LYNN COMMUNITY HEALTH CENTER","A-FLEX-WCC-P-N",46.55],
      ["LYNN COMMUNITY HEALTH CENTER","A-FLEX-WCC-S-N",71.37],
      ["LYNN COMMUNITY HEALTH CENTER","A-AUD-PSTN-IBTF",0],
      ["LYNN COMMUNITY HEALTH CENTER","A-AUD-U-IBTF",0],
      ["LYNN COMMUNITY HEALTH CENTER","A-AUD-OCP1-U",0],
      ["LYNN COMMUNITY HEALTH CENTER","A-AUD-U-TN",0],
      ["LYNN COMMUNITY HEALTH CENTER","A-CHAN-U-V-FRUS-OB",0],
      ["LYNN COMMUNITY HEALTH CENTER","A-CHAN-V-PORTS",0],
      ["LYNN COMMUNITY HEALTH CENTER","A-FLEX-WCE-E",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-FLEX-WCC-S-C",21.7],
      ["ROEHL TRANSPORTHARVEY MILLER","A-FLEX-WCC-P-C",21.7],
      ["ROEHL TRANSPORTHARVEY MILLER","SVS-CSS-SUPT-SSPT",120],
      ["ROEHL TRANSPORTHARVEY MILLER","A-FLEX-EACL",21.7],
      ["ROEHL TRANSPORTHARVEY MILLER","A-FLEX-WCC-P-N",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-FLEX-WCC-S-N",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-AUD-PSTN-IBTF",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-AUD-U-IBTF",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-AUD-OCP1-U",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-AUD-U-TN",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-CHAN-U-V-FRUS-OB",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-CHAN-V-PORTS",0],
      ["ROEHL TRANSPORTHARVEY MILLER","A-FLEX-WCE-E",0],
      ["ECO WINDOW SYSTEMS LLC","A-FLEX-NUCL-E",69.58],
      ["LYNN COMMUNITY HEALTH CTR","A-FLEX-EACL",92.31]
    ];

    // === GLOBAL DATA ===
    let invoiceNumber = '—';
    let invoiceMonthYear = '—';
    let allGroups = {}, allTaxes = {}, taxDetails = {}, headers = [];
    let extIdx = -1, serviceIdx = -1, skuIdx = -1;
    let startDateIdx = -1, endDateIdx = -1;
    const statusDiv = document.getElementById('status');

    // Chart.js instance
    let revenueChart = null;

    // === DATE FORMATTING ===
    function formatDateToMMDDYY(val) {
      if (!val) return '';
      if (typeof val === 'number') {
        const date = XLSX.SSF.parse_date_code(val);
        if (!date) return val;
        return `${String(date.m).padStart(2, '0')}/${String(date.d).padStart(2, '0')}/${String(date.y).slice(-2)}`;
      } else if (typeof val === 'string') {
        if (val.length === 8 && /^\d{8}$/.test(val)) {
          return `${val.slice(4,6)}/${val.slice(6,8)}/${val.slice(2,4)}`;
        }
        const date = new Date(val);
        if (!isNaN(date.getTime())) {
          return `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}/${String(date.getFullYear()).slice(-2)}`;
        }
      }
      return val;
    }

    function formatInvoiceMonthYear(val) {
      if (!val) return '';
      if (typeof val === 'number') {
        const date = XLSX.SSF.parse_date_code(val);
        if (date) return `${String(date.m).padStart(2,'0')}/${date.y}`;
      }
      if (typeof val === 'string') {
        val = val.trim().split(/\s+/)[0];
        const match = val.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{2,4})$/);
        if (match) {
          const month = parseInt(match[1], 10);
          const year = parseInt(match[3], 10);
          const fullYear = year < 100 ? 2000 + year : year;
          return `${month.toString().padStart(2,'0')}/${fullYear}`;
        }
        const date = new Date(val);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('en-US', { month: 'numeric', year: 'numeric' });
        }
      }
      return val.trim();
    }

    // === PIE CHART - PROFIT/MARGIN BY CUSTOMER ===
    function updateRevenueChart() {
      if (extIdx === -1 || !Object.keys(allGroups).length) {
        if (revenueChart) revenueChart.destroy();
        revenueChart = null;
        return;
      }

      const customerProfits = {};

      Object.entries(allGroups).forEach(([service, rows]) => {
        let profit = 0;
        rows.forEach(r => {
          const ext = parseFloat(r[extIdx]) || 0;
          const sku = r[skuIdx] || '';
          const marginPct = getMarginFor(service, sku);
          const markupTotal = ext * (1 + marginPct / 100);
          profit += (markupTotal - ext);
        });
        if (profit > 0) {
          customerProfits[service] = profit;
        }
      });

      const labels = Object.keys(customerProfits);
      const data = Object.values(customerProfits);
      const totalProfit = data.reduce((sum, val) => sum + val, 0);

      if (totalProfit <= 0 || labels.length === 0) {
        if (revenueChart) revenueChart.destroy();
        return;
      }

      const backgroundColors = [
        '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc949',
        '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab', '#4e79a7',
        '#b07aa1', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd'
      ];

      const ctx = document.getElementById('revenuePieChart').getContext('2d');

      if (revenueChart) {
        revenueChart.destroy();
      }

      revenueChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels.map(cust => `${cust} ($${customerProfits[cust].toFixed(2)})`),
          datasets: [{
            data: data,
            backgroundColor: backgroundColors.slice(0, labels.length),
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                font: { size: 13 },
                padding: 20,
                boxWidth: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const percentage = ((value / totalProfit) * 100).toFixed(1);
                  const label = context.label.split(' ($')[0];
                  return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                }
              }
            },
            title: {
              display: true,
              text: `Total Profit / Margin: $${totalProfit.toFixed(2)}`,
              font: { size: 16 },
              padding: { top: 10, bottom: 20 }
            }
          }
        }
      });
    }

    // === MODAL LOGIC ===
    const modal = document.getElementById('marginsModal');
    const txtService = document.getElementById('txtService');
    const txtSKU = document.getElementById('txtSKU');
    const txtMargin = document.getElementById('txtMargin');
    const lstMargins = document.getElementById('lstMargins');
    const serviceSuggestions = document.getElementById('serviceSuggestions');
    const skuSuggestions = document.getElementById('skuSuggestions');
    const importRulesInput = document.getElementById('importRulesInput');

    function updateSuggestions() {
      const services = [...new Set(marginRules.map(r => r[0]))].sort();
      const skus = [...new Set(marginRules.map(r => r[1]))].sort();
      serviceSuggestions.innerHTML = services.map(s => `<option value="${s}">`).join('');
      skuSuggestions.innerHTML = skus.map(s => `<option value="${s}">`).join('');
    }

    function loadMarginsList() {
      lstMargins.innerHTML = '';
      marginRules.forEach((r, i) => {
        const opt = new Option(`${r[0]} | ${r[1]} | ${r[2].toFixed(4)}%`, i);
        lstMargins.add(opt);
      });
    }

    function clearForm() {
      txtService.value = '';
      txtSKU.value = '';
      txtMargin.value = '';
      lstMargins.selectedIndex = -1;
    }

    document.getElementById('btnEditMargins').onclick = () => {
      updateSuggestions();
      loadMarginsList();
      clearForm();
      modal.style.display = 'flex';
    };

    document.getElementById('btnCloseModal').onclick = () => modal.style.display = 'none';

    document.getElementById('btnAdd').onclick = () => {
      const service = txtService.value.trim();
      const sku = txtSKU.value.trim();
      const marginText = txtMargin.value.trim();
      if (!service || !sku) return alert("Service To and SKU are required");
      if (!/^\d*\.?\d*$/.test(marginText)) return alert("Margin must be a number (e.g. 49.1)");
      const margin = parseFloat(marginText);
      const existing = marginRules.findIndex(r => r[0] === service && r[1] === sku);
      if (existing >= 0) {
        marginRules[existing][2] = margin;
        alert("Rule updated");
      } else {
        marginRules.push([service, sku, margin]);
        alert("New rule added");
      }
      updateSuggestions();
      loadMarginsList();
      clearForm();
    };

    document.getElementById('btnDelete').onclick = () => {
      const idx = lstMargins.selectedIndex;
      if (idx === -1) return alert("Select a rule to delete");
      marginRules.splice(idx, 1);
      loadMarginsList();
      updateSuggestions();
      clearForm();
    };

    lstMargins.onclick = () => {
      const idx = lstMargins.selectedIndex;
      if (idx === -1) return;
      const r = marginRules[idx];
      txtService.value = r[0];
      txtSKU.value = r[1];
      txtMargin.value = r[2].toFixed(4);
    };

    document.getElementById('btnExportRules').onclick = () => {
      const dataStr = JSON.stringify(marginRules, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'margin-rules.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('btnImportRules').onclick = () => {
      const file = importRulesInput.files[0];
      if (!file) return alert("Select a JSON file to import");
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const imported = JSON.parse(e.target.result);
          if (!Array.isArray(imported)) throw new Error('Invalid format');
          marginRules = imported;
          updateSuggestions();
          loadMarginsList();
          alert(`Imported ${imported.length} margin rules successfully!`);
        } catch (err) {
          alert('Error importing rules: ' + err.message);
        }
      };
      reader.readAsText(file);
    };

    // === IMPORT INVOICE ===
    document.getElementById('btnImport').onclick = () => {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert("Select file");
      statusDiv.textContent = "Processing...";
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheetName = Object.keys(wb.Sheets).find(n => n.toLowerCase().includes('consolidated'));
          if (!sheetName) throw new Error('No ConsolidatedInvoice sheet');
          const sheet = wb.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
          let headerRow = -1;
          for (let i = 0; i < Math.min(json.length, 100); i++) {
            if (json[i].some(c => String(c).toLowerCase().includes('sku'))) {
              headerRow = i; break;
            }
          }
          if (headerRow === -1) throw new Error('Header row not found');

          // === IMPROVED INVOICE NUMBER & DATE DETECTION ===
          invoiceNumber = '—';
          invoiceMonthYear = '—';
          for (let r = 0; r < Math.min(60, json.length); r++) {
            const row = json[r];
            for (let c = 0; c < row.length; c++) {
              const cellText = String(row[c] || '').trim();
              const cellUpper = cellText.toUpperCase();

              // Invoice Date
              if (cellUpper.includes('INVOICE DATE') || (cellUpper.includes('DATE') && cellUpper.includes('INVOICE'))) {
                let dateStr = '';
                const colonParts = cellText.split(':');
                if (colonParts.length > 1) dateStr = colonParts[1].trim();
                if (!dateStr && c + 1 < row.length) dateStr = String(row[c + 1] || '').trim();
                if (!dateStr && r + 1 < json.length && c < json[r + 1].length) dateStr = String(json[r + 1][c] || '').trim();
                if (dateStr) invoiceMonthYear = formatInvoiceMonthYear(dateStr);
              }

              // SAP Invoice Number - stricter
              const sapPatterns = [
                'SAP INVOICE NO', 'SAP INVOICE #', 'SAP INVOICE NUMBER',
                'SAP INV NO', 'SAP INV #', 'SAP INV NUMBER',
                'INVOICE NO', 'INVOICE #', 'INVOICE NUMBER'
              ];

              if (sapPatterns.some(p => cellUpper.includes(p)) && !cellUpper.startsWith('INVOICE DATE')) {
                let numStr = '';
                const parts = cellText.split(/[:\s]{2,}|[:\s]+(?=\d)/);
                if (parts.length > 1) numStr = parts[1].trim();
                if (!numStr && c + 1 < row.length) numStr = String(row[c + 1] || '').trim();
                if (!numStr && r + 1 < json.length && c < json[r + 1].length) numStr = String(json[r + 1][c] || '').trim();

                if (numStr && /\d/.test(numStr) && numStr.length < 30 &&
                    !numStr.toUpperCase().includes('ORIGINAL') &&
                    !numStr.toUpperCase().includes('LINE') &&
                    !numStr.toUpperCase().includes('COLUMN')) {
                  invoiceNumber = numStr;
                }
              }
            }
          }
          if (invoiceMonthYear === '—') {
            const today = new Date();
            invoiceMonthYear = today.toLocaleDateString('en-US', { month: 'numeric', year: 'numeric' });
          }

          headers = json[headerRow];
          const rows = json.slice(headerRow + 1);

          const findCol = names => {
            for (let i = 0; i < headers.length; i++) {
              if (names.some(n => String(headers[i]).toLowerCase().includes(n.toLowerCase()))) return i;
            }
            return -1;
          };

          extIdx = findCol(['Extended Amount']);
          serviceIdx = findCol(['Service To']);
          skuIdx = findCol(['SKU']);
          startDateIdx = findCol(['Start Date']);
          endDateIdx = findCol(['End Date']);

          // FIXED: Use === for comparison
          if (extIdx === -1 || serviceIdx === -1 || skuIdx === -1) {
            const missing = [];
            if (extIdx === -1) missing.push('Extended Amount');
            if (serviceIdx === -1) missing.push('Service To');
            if (skuIdx === -1) missing.push('SKU');
            throw new Error(`Missing required columns: ${missing.join(', ')}`);
          }

          const validRows = rows.filter(r => {
            const ext = r[extIdx];
            return ext && parseFloat(ext) > 0 && !String(ext).includes('-');
          });

          if (validRows.length === 0) throw new Error('No valid rows');

          allGroups = {};
          validRows.forEach(r => {
            const service = r[serviceIdx] || 'Unknown';
            if (!allGroups[service]) allGroups[service] = [];
            allGroups[service].push(r);
          });

          const filter = document.getElementById('filterService');
          filter.innerHTML = '<option value="">Show All</option>';
          Object.keys(allGroups).sort().forEach(s => filter.add(new Option(s, s)));

          statusDiv.textContent = `Imported ${validRows.length} rows. | Invoice: ${invoiceNumber} | Period: ${invoiceMonthYear}`;

          renderTable();
          updateRevenueChart();
        } catch (err) {
          statusDiv.textContent = 'Error: ' + err.message;
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    };

    // === IMPORT TAX ===
    document.getElementById('btnImportTax').onclick = () => {
      const file = document.getElementById('taxInput').files[0];
      if (!file) return alert("Select tax file");
      statusDiv.textContent = "Processing tax...";
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheetName = wb.SheetNames[0];
          const sheet = wb.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
          let headerRow = -1;
          for (let i = 0; i < Math.min(json.length, 100); i++) {
            if (json[i].some(c => String(c).toLowerCase().includes('sku'))) {
              headerRow = i; break;
            }
          }
          if (headerRow === -1) throw new Error('Service header row not found');
          const serviceCol = json[headerRow].findIndex(h => String(h).toLowerCase().includes('service to'));
          if (serviceCol === -1) throw new Error('Service To column not found');
          const service = json[headerRow + 1][serviceCol] || 'Unknown';
          let taxStart = -1;
          for (let i = 0; i < json.length; i++) {
            if (json[i].some(c => String(c).toLowerCase().includes('tax and other charges'))) {
              taxStart = i; break;
            }
          }
          if (taxStart === -1) throw new Error('Tax section not found');
          const taxHeader = json[taxStart + 1];
          const lineNoIdx = taxHeader.findIndex(h => String(h).toLowerCase().includes('line no'));
          const categoryIdx = taxHeader.findIndex(h => String(h).toLowerCase().includes('category'));
          const amountIdx = taxHeader.findIndex(h => String(h).toLowerCase().includes('amount'));
          const typeIdx = taxHeader.findIndex(h => String(h).toLowerCase().includes('type'));
          if (amountIdx === -1 || typeIdx === -1) throw new Error('Tax columns not found');
          let totalTax = 0;
          const details = [];
          for (let i = taxStart + 2; i < json.length; i++) {
            const row = json[i];
            if (row.length === 0 || !row[0]) break;
            const amount = parseFloat(row[amountIdx]) || 0;
            totalTax += amount;
            details.push({
              lineNo: row[lineNoIdx] || '',
              category: row[categoryIdx] || '',
              amount: amount.toFixed(2),
              type: row[typeIdx] || ''
            });
          }
          allTaxes[service.trim()] = totalTax;
          taxDetails[service.trim()] = details;
          statusDiv.textContent = `Imported tax for ${service}: $${totalTax.toFixed(2)} (${details.length} lines)`;
          renderTable();
          updateRevenueChart();
        } catch (err) {
          statusDiv.textContent = 'Error: ' + err.message;
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    };

    // === RENDER TABLE ===
    document.getElementById('filterService').onchange = () => {
      renderTable();
      updateRevenueChart();
    };

    function renderTable() {
      const sel = document.getElementById('filterService').value;
      const groups = sel ? { [sel]: allGroups[sel] } : allGroups;
      let html = `<table><thead><tr>`;
      headers.forEach(h => html += `<th>${h}</th>`);
      html += `<th>Margin %</th><th>Markup Total</th></tr></thead><tbody>`;
      let filteredGT = 0;
      let hasTaxes = false;
      Object.keys(groups).sort().forEach(service => {
        let black = 0, green = 0, groupMarkup = 0;
        groups[service].forEach(r => {
          const ext = parseFloat(r[extIdx]) || 0;
          const sku = r[skuIdx] || '';
          const marginPct = getMarginFor(service, sku);
          const markup = ext * (1 + marginPct / 100);
          groupMarkup += markup;
          if (marginPct > 0) green += markup;
          else black += markup;
          const rowCopy = [...r];
          if (startDateIdx !== -1) rowCopy[startDateIdx] = formatDateToMMDDYY(rowCopy[startDateIdx]);
          if (endDateIdx !== -1) rowCopy[endDateIdx] = formatDateToMMDDYY(rowCopy[endDateIdx]);
          rowCopy.push(marginPct.toFixed(4));
          rowCopy.push(markup.toFixed(2));
          html += `<tr>`;
          rowCopy.forEach((c, i) => {
            if (i === serviceIdx) html += `<td class="service-to">${c}</td>`;
            else if (i === rowCopy.length - 1) html += `<td class="markup-${marginPct > 0 ? 'green' : 'black'}">${c}</td>`;
            else if (i === rowCopy.length - 2) html += `<td class="margin-cell">${c}%</td>`;
            else html += `<td>${c}</td>`;
          });
          html += `</tr>`;
        });
        html += `<tr class="subtotal-black"><td colspan="${headers.length}">Subtotal (0% Margin)</td><td></td><td>${black.toFixed(2)}</td></tr>`;
        html += `<tr class="subtotal-green"><td colspan="${headers.length}">Subtotal (Markup Applied)</td><td></td><td>${green.toFixed(2)}</td></tr>`;
        html += `<tr class="group-total"><td colspan="${headers.length}">Total for ${service} (Tax not Included)</td><td></td><td>${groupMarkup.toFixed(2)}</td></tr>`;
        const tax = allTaxes[service.trim()] || 0;
        if (tax > 0) {
          hasTaxes = true;
          html += `<tr class="tax-total"><td colspan="${headers.length}">Total Tax</td><td></td><td>${tax.toFixed(2)}</td></tr>`;
          html += `<tr class="group-total"><td colspan="${headers.length}">Grand Total for ${service} (Including Tax)</td><td></td><td>${(groupMarkup + tax).toFixed(2)}</td></tr>`;
        }
        filteredGT += groupMarkup + tax;
      });
      html += `<tr class="grand-total"><td colspan="${headers.length}">GRAND TOTAL:${hasTaxes ? ' (Including Tax)' : ' (Tax not Included)'}</td><td></td><td>${filteredGT.toFixed(2)}</td></tr>`;
      html += `</tbody></table>`;
      document.getElementById('output').innerHTML = html;

      updateRevenueChart();
    }

    function getMarginFor(service, sku) {
      for (const r of marginRules) {
        const sMatch = r[0] === '*' || r[0] === service;
        const kMatch = r[1] === '*' || r[1] === sku;
        if (sMatch && kMatch) return r[2];
      }
      return 0;
    }

    // === CLEAR ===
    document.getElementById('btnClear').onclick = () => {
      document.getElementById('output').innerHTML = '';
      document.getElementById('fileInput').value = '';
      document.getElementById('taxInput').value = '';
      document.getElementById('filterService').innerHTML = '<option value="">Show All</option>';
      allGroups = {}; allTaxes = {}; taxDetails = {}; headers = [];
      extIdx = serviceIdx = skuIdx = startDateIdx = endDateIdx = -1;
      invoiceNumber = '—';
      invoiceMonthYear = '—';
      statusDiv.textContent = '';

      if (revenueChart) {
        revenueChart.destroy();
        revenueChart = null;
      }
    };

    // === EXPORT CSV & EXCEL ===
    document.getElementById('btnExportCSV').onclick = () => {
      const tbl = document.querySelector('#output table');
      if (!tbl) return alert('No data');
      let csv = [];
      tbl.querySelectorAll('tr').forEach(row => {
        const cols = Array.from(row.cells).map(c => `"${c.innerText.replace(/"/g, '""')}"`);
        csv.push(cols.join(','));
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'invoice-markup.csv';
      a.click();
    };

    document.getElementById('btnExportExcel').onclick = () => {
      if (extIdx === -1) return alert('Import data first');
      const wb = XLSX.utils.book_new();
      const wsData = [];
      const header = [...headers, 'Margin %', 'Markup Total'];
      wsData.push(header);
      const sel = document.getElementById('filterService').value;
      const groups = sel ? { [sel]: allGroups[sel] } : allGroups;
      let grandTotal = 0;
      let hasTaxes = false;
      Object.keys(groups).sort().forEach(service => {
        let groupMarkup = 0;
        groups[service].forEach(r => {
          const ext = parseFloat(r[extIdx]) || 0;
          const sku = r[skuIdx] || '';
          const marginPct = getMarginFor(service, sku);
          const markup = ext * (1 + marginPct / 100);
          groupMarkup += markup;
          const row = [...r];
          if (startDateIdx !== -1) row[startDateIdx] = formatDateToMMDDYY(row[startDateIdx]);
          if (endDateIdx !== -1) row[endDateIdx] = formatDateToMMDDYY(row[endDateIdx]);
          row.push(marginPct.toFixed(4));
          row.push(markup.toFixed(2));
          wsData.push(row);
        });
        const black = groups[service].reduce((sum, r) => sum + (getMarginFor(service, r[skuIdx] || '') > 0 ? 0 : parseFloat(r[extIdx]) * (1 + getMarginFor(service, r[skuIdx] || '') / 100)), 0);
        const green = groups[service].reduce((sum, r) => sum + (getMarginFor(service, r[skuIdx] || '') > 0 ? parseFloat(r[extIdx]) * (1 + getMarginFor(service, r[skuIdx] || '') / 100) : 0), 0);
        wsData.push(['Subtotal (0% Margin)', '', black.toFixed(2)]);
        wsData.push(['Subtotal (Markup Applied)', '', green.toFixed(2)]);
        wsData.push([`Total for ${service} (Tax not Included)`, '', groupMarkup.toFixed(2)]);
        const tax = allTaxes[service.trim()] || 0;
        if (tax > 0) {
          hasTaxes = true;
          wsData.push(['Total Tax', '', tax.toFixed(2)]);
          wsData.push([`Grand Total for ${service} (Including Tax)`, '', (groupMarkup + tax).toFixed(2)]);
        }
        grandTotal += groupMarkup + tax;
      });
      wsData.push([`GRAND TOTAL:${hasTaxes ? ' (Including Tax)' : ' (Tax not Included)'}`, '', grandTotal.toFixed(2)]);
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "Markup");
      XLSX.writeFile(wb, "invoice-markup.xlsx");
    };
// === PRINT TO PDF - ONLY SHOW CONSUMPTION/OVERAGE ROWS + TAX ===
document.getElementById('btnPrintPDF').onclick = async () => {
  if (extIdx === -1) return alert('Import data first');
  const sel = document.getElementById('filterService').value;
  const servicesToPrint = sel ? [sel] : Object.keys(allGroups).sort();
  if (servicesToPrint.length === 0) return alert('No data to print');

  const { jsPDF } = window.jspdf;

  let currentYear, currentMonth;
  if (invoiceMonthYear !== '—') {
    const parts = invoiceMonthYear.split('/');
    currentMonth = parseInt(parts[0], 10);
    currentYear = parseInt(parts[1], 10);
  } else {
    const today = new Date();
    currentMonth = today.getMonth() + 1;
    currentYear = today.getFullYear();
  }

  const logoUrl = 'https://raw.githubusercontent.com/ThunderchickenII/InvoiceCleaner/main/workflow-01.jpg';
  let logoBase64 = '';
  try {
    const response = await fetch(logoUrl);
    const blob = await response.blob();
    logoBase64 = await new Promise(r => {
      const reader = new FileReader();
      reader.onloadend = () => r(reader.result);
      reader.readAsDataURL(blob);
    });
  } catch (e) {
    console.warn('Logo failed to load');
  }

  for (const service of servicesToPrint) {
    const doc = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    });
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    const safeService = service.trim();
    const safeName = safeService.replace(/[/\\?%*:|"<>]/g, '_').substring(0, 40);
    const tax = allTaxes[safeService] || 0;

    // Header (unchanged)
    if (logoBase64) {
      doc.addImage(logoBase64, 'JPEG', margin, margin, 60, 18);
    }
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Workflow Concepts', pageWidth - margin, margin + 5, { align: 'right' });
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('PO Box 1333', pageWidth - margin, margin + 10, { align: 'right' });
    doc.text('Scarborough ME, 04074', pageWidth - margin, margin + 15, { align: 'right' });
    doc.text('accounting@workflowconcepts.com', pageWidth - margin, margin + 20, { align: 'right' });

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text(`SAP No: ${invoiceNumber}`, pageWidth - margin, margin + 28, { align: 'right' });

    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('WEBEX INVOICE', pageWidth / 2, margin + 10, { align: 'center' });

    // NEW: Smaller centered subtitle right below the main title
    doc.setFontSize(12);                  // Slightly smaller than 18pt
    doc.setFont('helvetica', 'bold');   // Regular weight for contrast
    doc.text('Consumption-Overages-Taxes', pageWidth / 2, margin + 18, { align: 'center' });	

    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text(`Billed To: ${safeService}`, margin, margin + 35);
    doc.text(`Invoice Date: ${invoiceMonthYear}`, pageWidth - margin, margin + 35, { align: 'right' });

    // ────────────────────────────────────────────────────────
    // ONLY include rows from PRIOR periods
    // ────────────────────────────────────────────────────────
    const tableBody = [];   // ← declared only once
    let consumptionOverageSubtotal = 0;
    const previousRows = [];

    allGroups[service].forEach(r => {
      const startDateVal = r[startDateIdx];
      let itemMonth = null;
      let itemYear = null;
      let sortKey = 0;

      if (typeof startDateVal === 'number') {
        const date = XLSX.SSF.parse_date_code(startDateVal);
        if (date) {
          itemMonth = date.m;
          itemYear = date.y;
          sortKey = date.y * 100 + date.m;
        }
      } else if (typeof startDateVal === 'string') {
        const match = startDateVal.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{2,4})/);
        if (match) {
          itemMonth = parseInt(match[1], 10);
          const y = parseInt(match[3], 10);
          itemYear = y < 100 ? 2000 + y : y;
          sortKey = itemYear * 100 + itemMonth;
        }
      }

      const ext = parseFloat(r[extIdx]) || 0;
      const sku = r[skuIdx] || '';
      const marginPct = getMarginFor(service, sku);
      const totalWithMarkup = ext * (1 + marginPct / 100);

      if (itemYear && (itemYear < currentYear || (itemYear === currentYear && itemMonth < currentMonth))) {
        const rowData = [
          r[headers.findIndex(h => h?.toLowerCase().includes('sku'))] || '',
          r[headers.findIndex(h => h?.toLowerCase().includes('description'))] || '',
          r[serviceIdx] || '',
          formatDateToMMDDYY(r[startDateIdx]) || '',
          formatDateToMMDDYY(r[endDateIdx]) || '',
          r[headers.findIndex(h => h?.toLowerCase().includes('duration'))] ?? '',
          r[headers.findIndex(h => h?.toLowerCase().includes('qty'))] || '',
          totalWithMarkup.toFixed(2)
        ];
        previousRows.push({ data: rowData, sortKey });
        consumptionOverageSubtotal += totalWithMarkup;
      }
    });

    previousRows.sort((a, b) => b.sortKey - a.sortKey);

    // FIXED: No second 'const' — just assign
    tableBody.push(...previousRows.map(r => r.data));

    // Generate table
    let startY = margin + 45;

    doc.autoTable({
      head: [["SKU", "Description", "Service To", "Start Date", "End Date", "Duration Month(s)", "Qty", "Total"]],
      body: tableBody,
      startY: startY,
      theme: 'grid',
      headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold', halign: 'center', fontSize: 9 },
      styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak', textColor: [0, 0, 0] },
      columnStyles: {
        0: { halign: 'left' },
        1: { halign: 'left' },
        2: { halign: 'left' },
        3: { halign: 'center' },
        4: { halign: 'center' },
        5: { halign: 'center' },
        6: { halign: 'right' },
        7: { halign: 'right' }
      },
      margin: { left: margin, right: margin },
      didParseCell: function(data) {
        if (data.row.section === 'body' && data.column.index === 1) {
          data.cell.styles.fontSize = 7.5;
        }
        if (data.row.section === 'body') {
          data.cell.styles.textColor = [0, 0, 255];
        }
      }
    });

    const subtotal = consumptionOverageSubtotal;
    const grandTotal = subtotal + tax;

    let y = doc.lastAutoTable.finalY + 8;

    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0, 0, 0);
    doc.text(`Subtotal (Consumption/Overages) $${subtotal.toFixed(2)}`, pageWidth - margin, y, { align: 'right' });
    y += 6;
    doc.text(`Tax $${tax.toFixed(2)}`, pageWidth - margin, y, { align: 'right' });
    y += 7;
    doc.setFontSize(13);
    doc.text(`Grand Total $${grandTotal.toFixed(2)}`, pageWidth - margin, y, { align: 'right' });

    // Tax details page (unchanged)
    if (tax > 0 && taxDetails[safeService]) {
      doc.addPage();
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text('TAX DETAILS', pageWidth / 2, margin + 5, { align: 'center' });
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text(`Customer: ${safeService}`, margin, margin + 15);
      doc.text(`Invoice Date: ${invoiceMonthYear}`, pageWidth - margin, margin + 15, { align: 'right' });

      const taxBody = taxDetails[safeService].map(d => [d.lineNo, d.category, d.amount, d.type]);
      doc.autoTable({
        head: [['Line No', 'Category', 'Amount', 'Type']],
        body: taxBody,
        startY: margin + 22,
        theme: 'grid',
        headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold', halign: 'center', fontSize: 8 },
        styles: { fontSize: 7.5, cellPadding: 1.5 },
        margin: { left: margin, right: margin }
      });

      const taxLastY = doc.lastAutoTable.finalY + 5;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text(`Total Tax $${tax.toFixed(2)}`, pageWidth - margin, taxLastY, { align: 'right' });
    }

    const fileDate = invoiceMonthYear.replace(/\//g, '-');
    doc.save(`Webex_Invoice_${safeName}_${invoiceNumber}_${fileDate}.pdf`);
  }

  statusDiv.textContent = `Generated ${servicesToPrint.length} separate PDF invoice(s) successfully!`;
};   
  </script>
</body>
</html>






